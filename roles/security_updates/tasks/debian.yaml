---
- name: "Validate variables"
  tags: [debian, validation]
  block:
    - name: "Validate variables: unattended_upgrades"
      ansible.builtin.fail:
        msg: "unattended_upgrades variable is not defined or is not a dictionary"
      when: unattended_upgrades is not defined or unattended_upgrades is not mapping


- name: "Configure unattended_upgrades"
  when: unattended_upgrades.enabled | default(false) | bool
  tags: [debian, apt, security]
  block:
    - name: "Configure unattended_upgrades: 50unattended-upgrades template"
      ansible.builtin.template:
        src: "apt.conf.d/50unattended-upgrades.j2"
        dest: "/etc/apt/apt.conf.d/50unattended-upgrades"
        owner: "root"
        group: "root"
        mode: "0644"
      notify: "apt configuration changed"

    - name: "Configure unattended_upgrades: 20auto-upgrades template"
      ansible.builtin.template:
        src: "apt.conf.d/20auto-upgrades.j2"
        dest: "/etc/apt/apt.conf.d/20auto-upgrades"
        owner: "root"
        group: "root"
        mode: "0644"
      notify: "apt configuration changed"
  rescue:
    - name: "Configure unattended_upgrades: failure"
      ansible.builtin.debug:
        msg: "Unattended_upgrades configuration failed for {{ inventory_hostname }}"
      tags: [debian, apt, security, error]


- name: "Verify unattended_upgrades configuration"
  tags: [debian, apt, security, verification]
  block:
    - name: "Verify unattended_upgrades configuration: syntax"
      ansible.builtin.command: "unattended-upgrades --dry-run --debug"
      register: unattended_upgrades_test
      changed_when: false
      failed_when: unattended_upgrades_test.rc != 0

    - name: "Verify unattended_upgrades configuration: debug"
      ansible.builtin.debug:
        msg: "{{ unattended_upgrades_test.stdout }}"
      when: debug | default(false) | bool
